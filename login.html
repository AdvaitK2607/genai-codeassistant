import os
import csv
import traceback
from io import BytesIO

from flask import Flask, request, jsonify, send_from_directory
from flask_cors import CORS
from dotenv import load_dotenv

from PyPDF2 import PdfReader
import google.generativeai as genai

# ============================================================
# LOAD ENVIRONMENT
# ============================================================
load_dotenv()

GEMINI_API_KEY = os.getenv("GEMINI_API_KEY", "").strip()
DEFAULT_MODEL = "gemini-2.5-flash-preview-09-2025"

if GEMINI_API_KEY:
    genai.configure(api_key=GEMINI_API_KEY)
else:
    genai.configure()

# ============================================================
# FLASK APP SETUP (ONLY ONE APP)
# ============================================================
app = Flask(__name__)
CORS(app, resources={r"/*": {"origins": "*"}})

# ============================================================
# FRONTEND FILE ROUTES (NO templates / static)
# ============================================================

@app.route("/")
def home():
    return send_from_directory(".", "login.html")

@app.route("/style.css")
def css():
    return send_from_directory(".", "style.css")

@app.route("/script.js")
def js():
    return send_from_directory(".", "script.js")

@app.route("/favicon.ico")
def favicon():
    return "", 204  # silence browser error

# ============================================================
# HELPER FUNCTIONS
# ============================================================

def read_pdf(file):
    try:
        file.seek(0)
        reader = PdfReader(file)
        return "\n".join(
            p.extract_text() or "" for p in reader.pages[:10]
        )
    except Exception as e:
        return f"[PDF read error: {e}]"

def read_txt(file):
    try:
        file.seek(0)
        raw = file.read()
        return raw.decode("utf-8", errors="ignore")
    except Exception as e:
        return f"[TXT read error: {e}]"

def read_csv_file(file):
    try:
        file.seek(0)
        text = file.read().decode("utf-8", errors="ignore")
        rows = list(csv.reader(text.splitlines()))[:60]
        return "\n".join(", ".join(r) for r in rows)
    except Exception as e:
        return f"[CSV read error: {e}]"

def process_files(files):
    data = []
    for f in files:
        name = f.filename or "file"
        buf = BytesIO(f.read())

        if name.lower().endswith(".pdf"):
            txt = read_pdf(buf)
        elif name.lower().endswith(".csv"):
            txt = read_csv_file(buf)
        elif name.lower().endswith((".txt", ".log")):
            txt = read_txt(buf)
        else:
            txt = f"[Unsupported file type: {name}]"

        data.append((name, txt))
    return data

def build_prompt(user_prompt, file_context):
    base = f"""
You are an expert actuarial analysis assistant.

### Explanation
Explain clearly.

### Code
Provide correct code.

### Time & Space Complexity
Explain complexity.

### Suggestions
Provide improvements.

USER PROMPT:
{user_prompt}
"""

    if file_context:
        base += "\n\nFILES:\n"
        for name, text in file_context:
            base += f"\n--- {name} ---\n{text[:8000]}\n"

    return base

# ============================================================
# API ROUTES
# ============================================================

@app.route("/health")
def health():
    return jsonify({"status": "ok"}), 200

@app.route("/analyze", methods=["POST"])
def analyze():
    try:
        prompt = request.form.get("prompt", "").strip()
        model_name = request.form.get("model", DEFAULT_MODEL)

        if not prompt:
            return jsonify({"error": "Prompt is empty"}), 400

        files = request.files.getlist("files")
        file_context = process_files(files)

        final_prompt = build_prompt(prompt, file_context)

        model = genai.GenerativeModel(model_name)
        response = model.generate_content(final_prompt)

        output = getattr(response, "text", "").strip()
        if not output:
            return jsonify({"error": "Empty response from model"}), 500

        return jsonify({
            "content": output,
            "model_used": model_name
        })

    except Exception as e:
        traceback.print_exc()
        return jsonify({"error": str(e)}), 500

# ============================================================
# MAIN (RENDER COMPATIBLE)
# ============================================================

if __name__ == "__main__":
    port = int(os.environ.get("PORT", 10000))
    app.run(host="0.0.0.0", port=port)
